<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Downloads - Ask Chopper</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "S√∂hne", Helvetica, Arial, sans-serif;
            background: #000000;
            color: #ffffff;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 0;
            border-bottom: 1px solid #2d2d2d;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
        }

        .header p {
            font-size: 14px;
            color: #999999;
            margin-top: 5px;
        }

        .back-link {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #999999;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: #ffffff;
        }

        .category-section {
            margin-bottom: 50px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .section-header h2 {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .count-badge {
            background: #2d2d2d;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .downloads-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .download-card {
            background: #0d0d0d;
            border: 1px solid #2d2d2d;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
            position: relative;
        }

        .download-card:hover {
            border-color: #666666;
            transform: translateY(-2px);
        }

        .download-cover {
            width: 100%;
            aspect-ratio: 1;
            background: #1a1a1a;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .download-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(34, 197, 94, 0.9);
            backdrop-filter: blur(10px);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .download-info {
            padding: 16px;
        }

        .download-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .download-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #999999;
            margin-bottom: 12px;
        }

        .download-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .download-date {
            font-size: 11px;
            color: #666666;
            padding-top: 12px;
            border-top: 1px solid #2d2d2d;
        }

        .download-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .action-btn {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            border: none;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .play-btn {
            background: #ffffff;
            color: #000000;
        }

        .play-btn:hover {
            background: #e0e0e0;
        }

        .view-btn {
            background: transparent;
            color: #ffffff;
            border: 1px solid #666666 !important;
        }

        .view-btn:hover {
            border-color: #999999 !important;
            background: #1a1a1a;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: #0d0d0d;
            border: 1px dashed #2d2d2d;
            border-radius: 12px;
            color: #666666;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 8px;
            color: #999999;
        }

        .empty-state p {
            font-size: 14px;
            margin-bottom: 20px;
        }

        .browse-link {
            display: inline-block;
            padding: 10px 20px;
            background: #ffffff;
            color: #000000;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .browse-link:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        /* Audio Player */
        .audio-player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #0d0d0d;
            border-top: 1px solid #2d2d2d;
            padding: 15px 20px;
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 1000;
        }

        .audio-player.active {
            display: flex;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 0 0 250px;
        }

        .player-cover {
            width: 50px;
            height: 50px;
            background: #1a1a1a;
            border-radius: 6px;
            background-size: cover;
            background-position: center;
        }

        .player-details h4 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .player-details p {
            font-size: 11px;
            color: #999999;
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .player-btn {
            background: transparent;
            border: none;
            color: #ffffff;
            cursor: pointer;
            font-size: 20px;
            padding: 8px;
            transition: all 0.2s;
        }

        .player-btn:hover {
            color: #fbbf24;
        }

        .player-btn.play-pause {
            background: #ffffff;
            color: #000000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .player-btn.play-pause:hover {
            background: #fbbf24;
        }

        .player-progress {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-time {
            font-size: 11px;
            color: #999999;
            width: 40px;
            text-align: center;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: #2d2d2d;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: #ffffff;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .volume-slider {
            width: 80px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }

            .downloads-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
            }

            .player-info {
                flex: 0 0 150px;
            }

            .volume-control {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>My Downloads</h1>
                <p>Access your downloaded beats, packs, and music offline</p>
            </div>
            <a href="/beatpax" class="back-link">
                ‚Üê Back to Beat Pax
            </a>
        </div>

        <!-- Beats Section -->
        <div class="category-section">
            <div class="section-header">
                <h2>
                    ü•Å Beats
                    <span class="count-badge" id="beatsCount">0</span>
                </h2>
            </div>
            <div class="downloads-grid" id="beatsGrid">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Sound Pax Section -->
        <div class="category-section">
            <div class="section-header">
                <h2>
                    üéµ Sound Pax
                    <span class="count-badge" id="soundPaxCount">0</span>
                </h2>
            </div>
            <div class="downloads-grid" id="soundPaxGrid">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Music Section -->
        <div class="category-section">
            <div class="section-header">
                <h2>
                    üéß Music
                    <span class="count-badge" id="musicCount">0</span>
                </h2>
            </div>
            <div class="downloads-grid" id="musicGrid">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Audio Player -->
    <div class="audio-player" id="audioPlayer">
        <div class="player-info">
            <div class="player-cover" id="playerCover"></div>
            <div class="player-details">
                <h4 id="playerTitle">No track playing</h4>
                <p id="playerArtist">-</p>
            </div>
        </div>
        <div class="player-controls">
            <button class="player-btn" onclick="previousTrack()">‚èÆ</button>
            <button class="player-btn play-pause" id="playPauseBtn" onclick="togglePlayPause()">‚ñ∂</button>
            <button class="player-btn" onclick="nextTrack()">‚è≠</button>
            <div class="player-progress">
                <span class="progress-time" id="currentTime">0:00</span>
                <div class="progress-bar" id="progressBar" onclick="seekAudio(event)">
                    <div class="progress-bar-fill" id="progressFill"></div>
                </div>
                <span class="progress-time" id="duration">0:00</span>
            </div>
        </div>
        <div class="volume-control">
            <button class="player-btn" onclick="toggleMute()">üîä</button>
            <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="100" oninput="changeVolume(this.value)">
        </div>
    </div>

    <!-- Hidden audio element -->
    <audio id="audioElement"></audio>

    <script>
        async function loadDownloads() {
            try {
                const res = await fetch('/api/downloads/list');
                if (res.ok) {
                    const data = await res.json();
                    renderDownloads(data);
                }
            } catch (err) {
                console.error('Failed to load downloads:', err);
            }
        }

        function renderDownloads(data) {
            // Render Beats
            renderCategory('beatsGrid', data.beats || [], 'beatsCount');
            // Render Sound Pax
            renderCategory('soundPaxGrid', data.soundPax || [], 'soundPaxCount');
            // Render Music
            renderCategory('musicGrid', data.music || [], 'musicCount');
        }

        function renderCategory(containerId, downloads, countId) {
            const container = document.getElementById(containerId);
            const countBadge = document.getElementById(countId);

            countBadge.textContent = downloads.length;

            if (!downloads.length) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <h3>No Downloads Yet</h3>
                        <p>Downloads in this category will appear here</p>
                        <a href="/beatpax" class="browse-link">Browse Beat Pax</a>
                    </div>
                `;
                return;
            }

            container.innerHTML = downloads.map(download => {
                const pack = download.pack;
                const filesText = pack.files_count === 1 ? '1 file' : `${pack.files_count} files`;
                const downloadDate = new Date(download.downloaded_at).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });

                return `
                    <div class="download-card">
                        <div class="download-cover" style="background-image: url('${pack.cover_url || ''}')">
                            <div class="download-badge">
                                ‚úì ${filesText}
                            </div>
                        </div>
                        <div class="download-info">
                            <div class="download-title">${pack.title}</div>
                            <div class="download-meta">
                                ${pack.genre ? `<span>üéµ ${pack.genre}</span>` : ''}
                                ${pack.bpm ? `<span>‚è±Ô∏è ${pack.bpm} BPM</span>` : ''}
                                ${pack.musical_key ? `<span>üéπ ${pack.musical_key}</span>` : ''}
                            </div>
                            <div class="download-actions">
                                <button class="action-btn play-btn" onclick="playPack(${pack.id})">Play</button>
                                <button class="action-btn view-btn" onclick="downloadPack(${pack.id})">Re-Download</button>
                            </div>
                            <div class="download-date">Downloaded ${downloadDate}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Audio Player State
        let currentPlaylist = [];
        let currentTrackIndex = 0;
        let currentPack = null;
        const audioElement = document.getElementById('audioElement');
        const audioPlayer = document.getElementById('audioPlayer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const progressFill = document.getElementById('progressFill');
        const currentTimeSpan = document.getElementById('currentTime');
        const durationSpan = document.getElementById('duration');

        // Audio event listeners
        audioElement.addEventListener('loadedmetadata', () => {
            durationSpan.textContent = formatTime(audioElement.duration);
        });

        audioElement.addEventListener('timeupdate', () => {
            const progress = (audioElement.currentTime / audioElement.duration) * 100;
            progressFill.style.width = progress + '%';
            currentTimeSpan.textContent = formatTime(audioElement.currentTime);
        });

        audioElement.addEventListener('ended', () => {
            nextTrack();
        });

        audioElement.addEventListener('play', () => {
            playPauseBtn.textContent = '‚è∏';
        });

        audioElement.addEventListener('pause', () => {
            playPauseBtn.textContent = '‚ñ∂';
        });

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        async function playPack(packId) {
            try {
                // Fetch pack details with all audio files
                const res = await fetch(`/api/packs/${packId}`);
                if (!res.ok) {
                    alert('Failed to load pack details');
                    return;
                }

                const pack = await res.json();

                if (!pack.files || pack.files.length === 0) {
                    alert('This pack has no audio files');
                    return;
                }

                // Set up playlist
                currentPack = pack;
                currentPlaylist = pack.files;
                currentTrackIndex = 0;

                // Load and play first track
                await loadTrack(0);
                audioElement.play();

                // Show player
                audioPlayer.classList.add('active');
            } catch (err) {
                console.error('Failed to play pack:', err);
                alert('Failed to play pack. Please try again.');
            }
        }

        async function loadTrack(index) {
            if (index < 0 || index >= currentPlaylist.length) return;

            const track = currentPlaylist[index];
            currentTrackIndex = index;

            try {
                // Get audio file URL
                const res = await fetch(`/api/audio/${track.id}`);
                if (!res.ok) {
                    throw new Error('Failed to load audio file');
                }

                const data = await res.json();

                // Set audio source
                audioElement.src = data.url;

                // Update player UI
                document.getElementById('playerTitle').textContent = track.title;
                document.getElementById('playerArtist').textContent = `${currentPack.title} ‚Ä¢ Track ${index + 1} of ${currentPlaylist.length}`;
                document.getElementById('playerCover').style.backgroundImage = currentPack.cover_url ? `url('${currentPack.cover_url}')` : '';

            } catch (err) {
                console.error('Failed to load track:', err);
                alert('Failed to load track. Please try again.');
            }
        }

        function togglePlayPause() {
            if (audioElement.paused) {
                audioElement.play();
            } else {
                audioElement.pause();
            }
        }

        function previousTrack() {
            if (currentTrackIndex > 0) {
                loadTrack(currentTrackIndex - 1);
                audioElement.play();
            }
        }

        function nextTrack() {
            if (currentTrackIndex < currentPlaylist.length - 1) {
                loadTrack(currentTrackIndex + 1);
                audioElement.play();
            } else {
                // End of playlist
                audioElement.pause();
                audioElement.currentTime = 0;
            }
        }

        function seekAudio(event) {
            const progressBar = document.getElementById('progressBar');
            const clickX = event.offsetX;
            const width = progressBar.offsetWidth;
            const duration = audioElement.duration;

            audioElement.currentTime = (clickX / width) * duration;
        }

        function changeVolume(value) {
            audioElement.volume = value / 100;
        }

        function toggleMute() {
            audioElement.muted = !audioElement.muted;
            const volumeBtn = event.target;
            volumeBtn.textContent = audioElement.muted ? 'üîá' : 'üîä';
        }

        async function downloadPack(packId) {
            try {
                // Fetch pack details with all audio files
                const res = await fetch(`/api/packs/${packId}`);
                if (!res.ok) {
                    alert('Failed to load pack details');
                    return;
                }

                const pack = await res.json();

                if (!pack.files || pack.files.length === 0) {
                    alert('This pack has no audio files to download');
                    return;
                }

                // Download each file
                for (let i = 0; i < pack.files.length; i++) {
                    const file = pack.files[i];
                    const audioRes = await fetch(`/api/audio/${file.id}?download=true`);

                    if (audioRes.ok) {
                        const data = await audioRes.json();
                        // Open download URL in new tab
                        const link = document.createElement('a');
                        link.href = data.url;
                        link.download = file.title;
                        link.target = '_blank';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        // Small delay between downloads to avoid browser blocking
                        if (i < pack.files.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    }
                }

                alert(`Started downloading ${pack.files.length} file(s) from ${pack.title}`);
            } catch (err) {
                console.error('Failed to download pack:', err);
                alert('Failed to download pack. Please try again.');
            }
        }

        function viewCreator(userId) {
            window.location.href = `/profile/${userId}`;
        }

        // Load downloads on page load
        loadDownloads();
    </script>
</body>
</html>
